{{- $root := . }}
{{- with .Values.controllerManager }}
{{- if and (eq (.enabled | toString) "true") (eq (.identities.enabled | toString) "true") }}
apiVersion: spire.spiffe.io/v1alpha1
kind: ClusterSPIFFEID
metadata:
  name: {{ include "spire-controller-manager.fullname" $root }}-service-account-based
spec:
  spiffeIDTemplate: {{ .identities.spiffeIDTemplate | quote }}
  {{- with .identities.federatesWith }}
  federatesWith:
  {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .identities.podSelector }}
  podSelector:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .identities.namespaceSelector }}
  namespaceSelector:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .identities.dnsNameTemplates }}
  dnsNameTemplates:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .identities.workloadSelectorTemplates }}
  workloadTSelectoremplates:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .identities.ttl }}
  ttl: {{ . | quote }}
  {{- end }}
  {{- with .identities.jwtTTL }}
  jwtTtl: {{ . | quote }}
  {{- end }}
  admin: {{ .identities.admin }}
  downstream: {{ .identities.downstream }}
{{- end }}
{{- range $key, $value := .extraCRs.clusterSPIFFEIDs }}
{{-   range $mkey, $mvalue := $value.metadata }}
{{-     if not (has $mkey (list "labels" "annotations")) }}
{{-       fail (printf "Unsupported metadata property specified: %s" $mkey) }}
{{-     end }}
{{-   end }}
{{-   range $skey, $svalue := $value.spec }}
{{-     if not (has $skey (list "admin" "dnsNameTemplates" "downstream" "federatesWith" "jwtTtl" "namespaceSelector" "podSelector" "spiffeIDTemplate" "ttl" "workloadSelectorTemplates")) }}
{{-       fail (printf "Unsupported metadata property specified: %s" $skey) }}
{{-     end }}
{{-   end }}
{{-   range $rprop := list "spiffeIDTemplate" }}
{{-     if not (hasKey $value.spec $rprop) }}
{{-       fail (printf "Required property %s was not specified" $rprop) }}
{{-     end }}
{{-   end }}
---
apiVersion: spire.spiffe.io/v1alpha1
kind: ClusterSPIFFEID
metadata:
  {{- if ($value.metadata).name }}
  name: {{ $value.metadata.name }}
  {{- else }}
  name: {{ $root.Release.Namespace }}-{{ include "spire-controller-manager.fullname" $root }}-{{ $key }}
  {{- end }}
  {{- with $value.metadata }}
  {{- toYaml . | nindent 2 }}
  {{- end }}
spec:
  {{/* FIXME, automatcially add className here if not set. */}}
  {{- with $value.spec }}
  {{- toYaml . | nindent 2 }}
  {{- end }}
{{- end }}
{{- end }}
